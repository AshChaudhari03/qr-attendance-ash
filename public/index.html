<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Attendance</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
/* ---------------- BODY ---------------- */
body {
  margin:0; padding:0;
  font-family: 'Arial', sans-serif;
  background: linear-gradient(135deg,#dffaf0,#ffffff);
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
}

/* ---------------- HEADER ---------------- */
header {
  width:100%;
  background:#fff;
  padding:15px;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  gap:15px;
}
header img { height:50px; }
header h2 { color:#27ae60; font-size:24px; margin:0; }

/* ---------------- LOGIN ---------------- */
#loginSection {
  margin:20px 0;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
}
#loginSection input {
  padding:10px;
  font-size:16px;
  border-radius:5px;
  border:1px solid #ccc;
}
#loginSection button {
  padding:10px 20px;
  border-radius:5px;
  border:none;
  background:#27ae60;
  color:white;
  font-size:16px;
  cursor:pointer;
  transition: all 0.2s;
}
#loginSection button:hover{ background:#219653; transform:translateY(-2px); }

/* ---------------- BUTTONS ---------------- */
.control-buttons {
  display:flex; flex-wrap:wrap; justify-content:center; gap:10px;
  margin-bottom:15px;
}
.control-buttons button {
  background:#27ae60; color:white; padding:12px 25px; font-size:16px;
  border-radius:8px; box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  transition: all 0.2s;
}
.control-buttons button:hover { background:#219653; transform:translateY(-2px); }

/* ---------------- SCANNER ---------------- */
#reader{
  width:90%;
  max-width:400px;
  margin:15px auto;
  border-radius:8px;
  overflow:hidden;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
}

/* ---------------- MESSAGE ---------------- */
#msg{
  font-weight:bold;
  margin-top:10px;
  font-size:16px;
  min-height:24px;
  transition: all 0.3s ease;
}
.success{
  color:white;
  background:#27ae60;
  padding:5px 10px;
  border-radius:5px;
  animation: fadeOut 2s forwards;
}
@keyframes fadeOut{
  0%{opacity:1; transform:scale(1);}
  50%{opacity:1; transform:scale(1.1);}
  100%{opacity:0; transform:scale(1);}
}

/* ---------------- STATS ---------------- */
.stats{
  display:flex; justify-content:center; gap:30px; margin-top:10px;
  font-size:18px; font-weight:bold;
  color:#27ae60;
}

/* ---------------- TABLE ---------------- */
table{
  width:95%;
  max-width:800px;
  margin:20px auto;
  border-collapse:collapse;
  box-shadow:0 3px 6px rgba(0,0,0,0.1);
  border-radius:8px;
  overflow:hidden;
}
th,td{
  border:1px solid #ddd;
  padding:10px;
  text-align:center;
}
th{
  background:#27ae60; color:white;
  font-size:16px;
}
tr:nth-child(even){ background:#f2fff2; }
tr:hover{ background:#e6ffe6; }

/* Highlight last scanned */
tr.last-scanned{
  background:#ffeaa7 !important;
  animation: highlight 2s ease-in-out;
}
@keyframes highlight{
  0%{background:#ffeaa7;}
  50%{background:#fff59d;}
  100%{background:#ffeaa7;}
}

/* ---------------- RESPONSIVE ---------------- */
@media(max-width:768px){
  .control-buttons{ flex-direction:column; }
  #loginSection{ flex-direction:column; }
  table, th, td{ font-size:14px; padding:6px; }
  #reader{ width:100%; }
}
</style>
</head>

<body>

<header>
<img src="logo.png" alt="Company Logo">
<h2>QR Attendance System</h2>
</header>

<div id="loginSection">
<input id="pwd" type="password" placeholder="Enter Password">
<button id="loginBtn">Login</button>
</div>

<div id="app" style="display:none;">

<div class="control-buttons">
<button onclick="scan('IN')">Clock In</button>
<button onclick="scan('OUT')">Clock Out</button>
<button onclick="undo()">Undo Last</button>
<button onclick="resetScreen()">Reset</button>
</div>

<div id="reader"></div>
<p id="msg"></p>

<h3>Today Attendance â€“ <span id="todayDate"></span></h3>
<div class="stats">
ðŸ§® IN: <span id="inC">0</span> | OUT: <span id="outC">0</span>
</div>

<table>
<thead>
<tr><th>ID</th><th>Name</th><th>Clock In</th><th>Clock Out</th><th>Delete</th></tr>
</thead>
<tbody id="list"></tbody>
</table>

<br>
From <input type="date" id="from"> To <input type="date" id="to">
<button onclick="exportExcel()">Export Excel</button>

</div>

<audio id="beep">
<source src="/public/wood_plank_flicks.ogg" type="audio/ogg">
</audio>

<script>
let scanner;
let scanning = false;
let lastScannedId = null;
let msgTimeout = null;

// Helper: show message
function showMessage(text, success=true){
  const msgEl = document.getElementById("msg");
  msgEl.innerText = text;
  if(success) msgEl.classList.add("success"); else msgEl.classList.remove("success");

  if(msgTimeout) clearTimeout(msgTimeout);
  msgTimeout = setTimeout(()=>{ msgEl.innerText=""; msgEl.classList.remove("success"); },3000);
}

// LOGIN
document.getElementById("loginBtn").onclick = function(){
 fetch("/login",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body: JSON.stringify({password: document.getElementById("pwd").value})
 })
 .then(r=>{
   if(r.ok){
     document.getElementById("app").style.display="block";
     load();
   } else alert("Wrong password");
 });
};

document.getElementById("todayDate").innerText = new Date().toLocaleDateString();

// LOAD ATTENDANCE
function load(){
 loadStats();
 fetch("/today").then(r=>r.json()).then(d=>{
  const list = document.getElementById("list");
  list.innerHTML="";
  d.forEach((x)=>{
   const tr = document.createElement("tr");
   if(x.id === lastScannedId) tr.classList.add("last-scanned");
   tr.innerHTML = `<td>${x.employee_id}</td>
                   <td>${x.employee_name}</td>
                   <td>${x.clock_in_ts?new Date(x.clock_in_ts).toLocaleTimeString():""}</td>
                   <td>${x.clock_out_ts?new Date(x.clock_out_ts).toLocaleTimeString():""}</td>
                   <td><button onclick="del(${x.id})">X</button></td>`;
   list.appendChild(tr);
  });
 });
}

// TODAY STATS
function loadStats(){
 fetch("/stats/today").then(r=>r.json()).then(d=>{
  document.getElementById("inC").innerText=d.inCount;
  document.getElementById("outC").innerText=d.outCount;
 });
}

// DELETE
function del(id){ 
  if(msgTimeout) clearTimeout(msgTimeout);
  document.getElementById("msg").innerText="";
  fetch("/attendance/"+id,{method:"DELETE"}).then(load); 
}

// UNDO LAST
function undo(){ 
  if(msgTimeout) clearTimeout(msgTimeout);
  document.getElementById("msg").innerText="";
  fetch("/undo",{method:"POST"}).then(load); 
}

// RESET SCREEN
function resetScreen(){
 document.getElementById("list").innerHTML="";
 document.getElementById("inC").innerText=0;
 document.getElementById("outC").innerText=0;
 document.getElementById("msg").innerText="";
 lastScannedId = null;
 if(msgTimeout) clearTimeout(msgTimeout);
}

// EXPORT EXCEL
function exportExcel(){
 let url="/export";
 if(from.value && to.value) url+=`?from=${from.value}&to=${to.value}`;
 window.location=url;
}

// SCANNER
function scan(type){
 if(scanning) return;
 scanning = true;
 const msgEl = document.getElementById("msg");
 msgEl.innerText="";
 if(msgTimeout) clearTimeout(msgTimeout);

 scanner = new Html5Qrcode("reader");
 scanner.start({facingMode:"environment"},{fps:10,qrbox:250}, qr=>{
   scanner.stop().catch(()=>{}); scanning=false;
   document.getElementById("beep").play();

   fetch("/scan",{method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({qr,type})})
   .then(r=>r.json()).then(d=>{
     if(d.ok){
       showMessage(d.ok,true);
     } else{
       showMessage(d.error,false);
     }

     // Highlight last scanned employee robustly
     fetch("/today").then(r=>r.json()).then(att=>{
       if(att.length) lastScannedId = att[0].id;
       load();
     });
   });
 });

 setTimeout(()=>{ scanner?.stop().catch(()=>{}); scanning=false; },20000);
}
</script>
</body>
</html>
